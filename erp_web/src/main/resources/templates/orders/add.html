<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="none">
<head>
<meta charset="UTF-8">
<title>采购申请</title>
<link th:href="@{/easyui/themes/default/easyui.css}" rel="stylesheet" type="text/css" href="/easyui/themes/default/easyui.css">
<link th:href="@{/easyui/themes/icon.css}" rel="stylesheet" type="text/css" href="/easyui/themes/icon.css">
<script type="text/javascript" src="/easyui/jquery.min.js" th:src="@{/easyui/jquery.min.js}"></script>
<script type="text/javascript" src="/easyui/jquery.easyui.min.js" th:src="@{/easyui/jquery.easyui.min.js}"></script>
<script type="text/javascript" src="/easyui/locale/easyui-lang-zh_CN.js" th:src="@{/easyui/locale/easyui-lang-zh_CN.js}"></script>
<script type="text/javascript" src="/js/form.js" th:src="@{/js/form.js}" ></script>
<script type="text/javascript" src="/easyui/jquery.easyui.min.js" th:src="@{/easyui/datagrid-detailview.js}"></script>
<script type="text/javascript" th:inline="javascript">
	var orderNameUrl = [[@{/goods/all}]];
</script>
<script type="text/javascript" >
	var lastRowIndex;
	$(function(){
		$("#grid").datagrid({
			columns:[[
				{field:'goodsuuid',title:'商品编号',width:100,align:'center',editor:{
					type:'numberbox',
					options:{disabled:true}
				}},
				{field:'goodsname',title:'商品名称',width:100,align:'center',editor:{
					type:'combobox',
					options:{url:orderNameUrl,textField:'name',valueField:'name',onSelect:function(record){
						bindGoodsData(record);
					}}
				}},
				{field:'price',title:'价格',width:100,align:'center',editor:{
					type:'numberbox',
					options:{precision:2,disabled:true}
				}},
				{field:'num',title:'数量',width:100,align:'center',editor:'numberbox'},
				{field:'money',title:'金额',width:100,align:'center',editor:{
					type:'numberbox',
					options:{disabled:true,precision:2}
				}}
			]],
			onSelect:function(index,row){
				$("#grid").datagrid("endEdit",lastRowIndex);
				lastRowIndex = index;
				$("#grid").datagrid("beginEdit",lastRowIndex);
				bindCalsEvent();
			},
			singleSelect:"true",
			toolbar:[{
				iconCls:'icon-add',
				text:'添加',
				handler:function(){
					$("#grid").datagrid('endEdit',lastRowIndex);
					$("#grid").datagrid('appendRow',{price:0,num:0,money:0});
					lastRowIndex = $("#grid").datagrid('getRows').length-1;
					$("#grid").datagrid('beginEdit',lastRowIndex);
					bindCalsEvent();
				}
			},{
				iconCls:'icon-remove',
				text:'删除',
				handler:function(){
					var row = $("#grid").datagrid("getSelected");
					if(row == null){
						if(lastRowIndex==0 || lastRowIndex > 0){
							var confirm = window.confirm("确定要删除最后一行吗?");
							if(confirm){
								var lastRows = $("#grid").datagrid('getRows');
								$("#grid").datagrid("endEdit",lastRows.length-1);
								var money = $("#totalMoney").html();
								$("#totalMoney").html(money-lastRows[lastRows.length-1].money);
								$("#grid").datagrid("deleteRow",lastRows.length-1);
								lastRowIndex--;
							}
						}else{
							alert("请选择删除的行");
						}
					}else{
						var confirm = window.confirm("确定要删除该行吗?");
						if(confirm){
							var money = $("#totalMoney").html();
							$("#totalMoney").html(parseFloat(money-row.money));
							$("#grid").datagrid('deleteRow',lastRowIndex);
							lastRowIndex = $("#grid").datagrid("getRows").length-1;
						}
					}
				}
			}]
		})
	})
	function cals(){
		var priceEditor = $("#grid").datagrid('getEditor',{index:lastRowIndex,field:'price'});
		var price = $(priceEditor.target).val();
		var numEditor = $("#grid").datagrid('getEditor',{index:lastRowIndex,field:'num'});
		var num = $(numEditor.target).val();
		var totalMoney = (price*num).toFixed(2);
		var moneyEditor = $("#grid").datagrid('getEditor',{index:lastRowIndex,field:'money'});
		$(moneyEditor.target).val(totalMoney);
		var rows = $("#grid").datagrid("getRows");
		$("#grid").datagrid('getRows')[lastRowIndex].money = totalMoney;
		var allMoney = 0;
		for(var i=0;i<rows.length;i++){
			allMoney+=parseFloat(rows[i].money);
		}
		$("#totalMoney").html(allMoney.toFixed(2));
	}
	function bindCalsEvent(){
		var priceEditor = $("#grid").datagrid("getEditor",{index:lastRowIndex,field:'price'});
		$(priceEditor.target).bind("keyup",function(){
			cals();
		})
		var numEditor = $("#grid").datagrid("getEditor",{index:lastRowIndex,field:'num'});
		$(numEditor.target).bind("keyup",function(){
			cals();
		})
	}
	function oo(){
		cals();
	}
	function bindGoodsData(record){
		var priceEditor = $("#grid").datagrid("getEditor",{index:lastRowIndex,field:'price'});
		$(priceEditor.target).val(record.outprice);
		var goodsUuidEditor = $("#grid").datagrid("getEditor",{index:lastRowIndex,field:'goodsuuid'});
		$(goodsUuidEditor.target).val(record.uuid);
	}
</script>
</head>
<body>
	<table id="grid"></table>
	<span id="totalMoney"></span><br/>
	<form >
	</form>
	<input type="button" onclick="oo()" value="提交审核" />
</body>
</html>